<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChaoYouHome - ค้นหาห้องเช่า บ้านเช่า และคอนโด</title>
    <meta name="description" content="ChaoYouHome (เช่าอยู่โฮม) - แพลตฟอร์มค้นหาห้องเช่า บ้านเช่า และคอนโดทั่วประเทศไทย ค้นหาที่พักในฝันของคุณได้ง่ายๆ วันนี้!">
    <meta name="keywords" content="เช่าอยู่, ChaoYouHome, เช่าบ้าน, เช่าคอนโด, หาห้องเช่า, บ้านเช่า, คอนโดให้เช่า, อสังหาริมทรัพย์ให้เช่า, ที่พัก, หาบ้านเช่า">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        /* Base styles */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f8f9fa;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Modal styles */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            z-index: 40;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            max-height: 90vh;
            overflow-y: auto;
        }
        /* Custom badge for boosted listings */
        .boosted-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background-color: #ffc107;
            color: #212529;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        }
        /* Admin table styles */
        #adminModal table th, #adminModal table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        /* Slideshow transition */
        .slide {
            transition: opacity 1s ease-in-out;
        }
        .upload-preview-img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Main Container -->
    <div id="app" class="container mx-auto p-4 md:p-6">

        <!-- Header -->
        <header class="relative flex justify-between items-center mb-6 pb-4 border-b">
            <h1 class="text-2xl md:text-3xl font-bold text-blue-600 cursor-pointer" onclick="navigateToHome()">
                <i class="fas fa-home mr-2"></i>ChaoYouHome
            </h1>
            
            <!-- Desktop Navigation -->
            <nav class="hidden md:block">
                <!-- Logged Out State -->
                <div id="nav-logged-out-view" class="flex items-center gap-2 md:gap-4">
                    <button onclick="openModal('loginModal')" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100"><i class="fas fa-sign-in-alt mr-2"></i>เข้าสู่ระบบ</button>
                    <button onclick="openModal('registerModal')" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"><i class="fas fa-user-plus mr-2"></i>สมัครสมาชิก</button>
                </div>
                <!-- Logged In State -->
                <div id="nav-logged-in-view" class="hidden items-center gap-4">
                    <button onclick="openModal('postModal')" class="px-4 py-2 text-sm font-medium text-white bg-green-500 rounded-lg hover:bg-green-600 flex items-center">
                        <i class="fas fa-plus mr-2"></i>ลงประกาศ
                    </button>
                    <button id="header-boost-button" class="px-4 py-2 text-sm font-medium text-white bg-purple-500 rounded-lg hover:bg-purple-600 flex items-center">
                        <i class="fas fa-rocket mr-2"></i>ดันโพสต์
                    </button>
                    <div class="relative">
                        <button id="profile-dropdown-button" onclick="toggleProfileDropdown()" class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white text-xl font-bold">
                            <!-- User Initial will be inserted here -->
                        </button>
                        <!-- Dropdown Menu -->
                        <div id="profile-dropdown-menu" class="hidden absolute top-full right-0 mt-2 w-64 bg-white rounded-lg shadow-xl z-30 border">
                            <div class="p-4 border-b">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                                        <span id="dropdown-user-initial"></span>
                                    </div>
                                    <div>
                                        <p id="dropdown-username" class="font-semibold"></p>
                                        <p id="dropdown-email" class="text-sm text-gray-500"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="p-2">
                                <a href="#" id="dropdown-profile-link" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md"><i class="fas fa-user-circle w-5 text-center"></i>โปรไฟล์</a>
                                <a href="#" id="dropdown-post-link" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md"><i class="fas fa-plus w-5 text-center"></i>ลงประกาศ</a>
                                <a href="#" id="dropdown-admin-link" class="hidden items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md"><i class="fas fa-user-shield w-5 text-center"></i>Admin Panel</a>
                                <hr class="my-2">
                                <a href="#" id="dropdown-logout-link" class="flex items-center gap-3 px-3 py-2 text-sm text-red-500 hover:bg-red-50 rounded-md"><i class="fas fa-sign-out-alt w-5 text-center"></i>ออกจากระบบ</a>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Mobile Hamburger Button -->
            <div class="md:hidden">
                <button id="mobile-menu-button" onclick="toggleMobileMenu()" class="text-2xl p-2">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </header>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white absolute top-[85px] left-0 right-0 z-30 shadow-lg border-t">
            <div id="mobile-nav-logged-out-view" class="p-4 space-y-2">
                <button onclick="openModal('loginModal'); toggleMobileMenu();" class="w-full text-left px-4 py-3 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200"><i class="fas fa-sign-in-alt mr-2"></i>เข้าสู่ระบบ</button>
                <button onclick="openModal('registerModal'); toggleMobileMenu();" class="w-full text-left px-4 py-3 text-white bg-blue-600 rounded-lg hover:bg-blue-700"><i class="fas fa-user-plus mr-2"></i>สมัครสมาชิก</button>
            </div>
            <div id="mobile-nav-logged-in-view" class="hidden">
                 <!-- Mobile Logged In Links will be populated by JS -->
            </div>
        </div>


        <!-- Page Views Container -->
        <main id="view-container">
            <!-- Home View -->
            <div id="home-view">
                <!-- Banner Slideshow Section -->
                <div id="banner-slideshow" class="relative rounded-xl overflow-hidden mb-8 h-64 md:h-96">
                    <!-- Slides -->
                    <div class="slide absolute inset-0 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1522771739844-6a9f6d5f14af?q=80&w=2071&auto=format&fit=crop');"></div>
                    <div class="slide absolute inset-0 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1570129477492-45c003edd2be?q=80&w=2070&auto=format&fit=crop');"></div>
                    <div class="slide absolute inset-0 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1618221195710-dd6b41faaea6?q=80&w=2000&auto=format&fit=crop');"></div>
                    
                    <!-- Text Overlay -->
                    <div class="absolute inset-0 bg-black bg-opacity-50 flex flex-col items-center justify-center text-center text-white p-4">
                        <h2 class="text-3xl md:text-5xl font-bold mb-3">ค้นหาห้องเช่า บ้านเช่า และคอนโด</h2>
                        <p class="text-md md:text-xl">แหล่งรวมประกาศให้เช่าที่ดีที่สุดสำหรับคุณ</p>
                    </div>

                    <!-- Navigation Buttons -->
                    <button id="prev-slide" class="absolute left-4 top-1/2 -translate-y-1/2 bg-white/30 hover:bg-white/50 text-white p-2 rounded-full z-10">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button id="next-slide" class="absolute right-4 top-1/2 -translate-y-1/2 bg-white/30 hover:bg-white/50 text-white p-2 rounded-full z-10">
                        <i class="fas fa-chevron-right"></i>
                    </button>

                    <!-- Dots -->
                    <div id="slide-dots" class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2 z-10"></div>
                </div>

                <!-- Search Section -->
                <div id="search-section" class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h2 class="text-xl font-bold mb-4">ค้นหาอสังหาริมทรัพย์ในฝันของคุณ</h2>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <select id="province-filter" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500">
                            <option value="">ทุกจังหวัด</option>
                        </select>
                        <select id="district-filter" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500">
                            <option value="">ทุกอำเภอ/เขต</option>
                        </select>
                        <select id="type-filter" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500">
                            <option value="">ทุกประเภท</option>
                            <option value="ห้องเช่า">ห้องเช่า</option>
                            <option value="บ้านเช่า">บ้านเช่า</option>
                            <option value="คอนโด">คอนโด</option>
                        </select>
                        <input type="number" id="max-price-filter" placeholder="ราคาสูงสุด (บาท)" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500" maxlength="10" oninput="if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);">
                        <button onclick="applyFilters()" class="w-full p-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-search mr-2"></i>ค้นหา
                        </button>
                    </div>
                </div>
                
                <!-- Listings Sections -->
                <div id="listings-section-container">
                    <div id="boosted-listings-container">
                        <h3 class="text-2xl font-bold mb-6" id="listings-title">ประกาศแนะนำ <i class="fas fa-star text-yellow-400"></i></h3>
                        <div id="listings-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                             <div id="loading-spinner" class="col-span-full text-center p-10">
                                 <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
                                 <p class="mt-2">กำลังโหลดข้อมูล...</p>
                             </div>
                        </div>
                    </div>
                    <div id="general-listings-container" class="mt-12">
                        <h3 class="text-2xl font-bold mb-6" id="general-listings-title">ประกาศทั่วไป</h3>
                        <div id="general-listings-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            <!-- General listings will be populated here -->
                        </div>
                    </div>
                </div>

            </div>

            <!-- Listing Detail View -->
            <div id="listing-detail-view" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-md"></div>

            <!-- User Profile View -->
            <div id="profile-view" class="hidden"></div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Login Modal -->
    <div id="loginModal" class="modal w-11/12 md:w-1/3 bg-white rounded-xl shadow-2xl p-8">
        <h3 class="text-2xl font-bold mb-6 text-center">เข้าสู่ระบบ</h3>
        <form id="login-form">
            <div class="mb-4">
                <label for="login-identifier" class="block text-sm font-medium text-gray-700 mb-1">อีเมล หรือ Username</label>
                <input type="text" id="login-identifier" class="w-full p-3 border rounded-lg" placeholder="กรอกอีเมลหรือ username ของคุณ" required maxlength="60">
            </div>
            <div class="mb-6">
                <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน</label>
                <input type="password" id="login-password" class="w-full p-3 border rounded-lg" required maxlength="100">
            </div>
            <button type="submit" class="w-full p-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">เข้าสู่ระบบ</button>
        </form>
        <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
        <button onclick="closeModal('loginModal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal w-11/12 md:w-1/3 bg-white rounded-xl shadow-2xl p-8">
        <h3 class="text-2xl font-bold mb-6 text-center">สมัครสมาชิก</h3>
        <form id="register-form">
            <div class="mb-4">
                <label for="register-username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                <input type="text" id="register-username" class="w-full p-3 border rounded-lg" required maxlength="30">
            </div>
            <div class="mb-4">
                <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">อีเมล</label>
                <input type="email" id="register-email" class="w-full p-3 border rounded-lg" required maxlength="60">
            </div>
            <div class="mb-4">
                <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน</label>
                <input type="password" id="register-password" class="w-full p-3 border rounded-lg" required maxlength="100">
            </div>
             <div class="mb-6">
                <label for="register-confirm-password" class="block text-sm font-medium text-gray-700 mb-1">ยืนยันรหัสผ่าน</label>
                <input type="password" id="register-confirm-password" class="w-full p-3 border rounded-lg" required maxlength="100">
            </div>
            <button type="submit" class="w-full p-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">สมัครสมาชิก</button>
        </form>
        <p id="register-error" class="text-red-500 text-sm mt-4 text-center"></p>
        <button onclick="closeModal('registerModal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
    </div>

    <!-- Post/Edit Listing Modal -->
    <div id="postModal" class="modal w-11/12 md:w-2/3 lg:w-1/2 bg-white rounded-xl shadow-2xl p-8">
        <h3 id="post-modal-title" class="text-2xl font-bold mb-6 text-center">ลงประกาศอสังหาริมทรัพย์</h3>
        <form id="post-form">
            <input type="hidden" id="post-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium">หัวข้อประกาศ</label>
                    <input type="text" id="post-title" class="w-full p-2 border rounded-lg" placeholder="เช่น คอนโดให้เช่า ใกล้ BTS อ่อนนุช" required maxlength="120">
                </div>
                <div>
                    <label class="block text-sm font-medium">ประเภท</label>
                    <select id="post-type" class="w-full p-2 border rounded-lg" required>
                        <option value="ห้องเช่า">ห้องเช่า</option>
                        <option value="บ้านเช่า">บ้านเช่า</option>
                        <option value="คอนโด">คอนโด</option>
                    </select>
                </div>
                <div>
                     <label class="block text-sm font-medium">ราคาเช่า (บาท/เดือน)</label>
                     <input type="number" id="post-price-rent" class="w-full p-2 border rounded-lg" placeholder="ระบุราคาเช่า" required maxlength="7" oninput="if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);">
                </div>
                 <div>
                     <label class="block text-sm font-medium">ราคาเข้าอยู่ครั้งแรก (บาท)</label>
                     <input type="number" id="post-price-initial" class="w-full p-2 border rounded-lg" placeholder="เช่น มัดจำ + ล่วงหน้า" maxlength="8" oninput="if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);">
                </div>
                <div>
                     <label class="block text-sm font-medium">วันที่เข้าอยู่ได้</label>
                     <input type="text" id="post-available-date" class="w-full p-2 border rounded-lg" placeholder="เลือกวันที่...">
                </div>
                <div>
                    <label class="block text-sm font-medium">จังหวัด</label>
                    <select id="post-province" class="w-full p-2 border rounded-lg" required></select>
                </div>
                <div>
                    <label class="block text-sm font-medium">อำเภอ/เขต</label>
                    <select id="post-district" class="w-full p-2 border rounded-lg" required></select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium">ตำบล/แขวง</label>
                    <select id="post-subdistrict" class="w-full p-2 border rounded-lg" required></select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium">รายละเอียดเพิ่มเติม</label>
                    <textarea id="post-description" rows="4" class="w-full p-2 border rounded-lg" required maxlength="1000"></textarea>
                </div>
                <div class="md:col-span-2">
                     <label class="block text-sm font-medium">รูปภาพ</label>
                     <input type="file" id="post-image-upload" class="w-full p-2 border rounded-lg" multiple accept="image/*">
                     <div id="image-preview-container" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
                 <div>
                    <label class="block text-sm font-medium">เบอร์โทรศัพท์</label>
                    <input type="tel" id="post-phone" class="w-full p-2 border rounded-lg" placeholder="เช่น 0812345678" required maxlength="15" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>
                 <div>
                    <label class="block text-sm font-medium">Line ID</label>
                    <input type="text" id="post-line-id" class="w-full p-2 border rounded-lg" placeholder="เช่น mylineid" required maxlength="30">
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-4">
                 <button type="button" onclick="closeModal('postModal')" class="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                 <button type="submit" id="post-submit-button" class="px-6 py-2 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600">บันทึกประกาศ</button>
            </div>
        </form>
         <p id="post-error" class="text-red-500 text-sm mt-4 text-center"></p>
        <button onclick="closeModal('postModal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
    </div>
    
    <!-- Admin Panel Modal -->
    <div id="adminModal" class="modal w-11/12 lg:w-5/6 bg-white rounded-xl shadow-2xl p-8">
        <h3 class="text-2xl font-bold mb-6 text-center">Admin Panel - จัดการประกาศทั้งหมด</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="bg-gray-100">
                        <th>หัวข้อประกาศ</th>
                        <th>ผู้ลงประกาศ</th>
                        <th>ประเภท</th>
                        <th>ราคา</th>
                        <th>วันที่อัปเดต</th>
                        <th>จัดการ</th>
                    </tr>
                </thead>
                <tbody id="admin-listings-table">
                    <!-- Admin listings will be injected here -->
                </tbody>
            </table>
        </div>
        <button onclick="closeModal('adminModal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal w-11/12 md:w-1/3 bg-white rounded-xl shadow-2xl p-8">
        <h3 class="text-2xl font-bold mb-6">แก้ไขข้อมูลส่วนตัว</h3>
        <form id="edit-profile-form">
            <div class="mb-4">
                <label class="block text-sm font-medium">เบอร์โทรศัพท์</label>
                <input type="tel" id="edit-profile-phone" class="w-full p-2 border rounded-lg" maxlength="15" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium">Line ID</label>
                <input type="text" id="edit-profile-line" class="w-full p-2 border rounded-lg" maxlength="30">
            </div>
            <div class="mt-6 flex justify-end gap-4">
                <button type="button" onclick="closeModal('editProfileModal')" class="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                <button type="submit" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">บันทึก</button>
            </div>
        </form>
    </div>

    <!-- Custom Alert Modal -->
    <div id="alertModal" class="modal w-11/12 md:w-1/3 bg-white rounded-xl shadow-2xl p-8">
        <h3 id="alert-modal-title" class="text-xl font-bold mb-4 text-center">แจ้งเตือน</h3>
        <p id="alert-modal-text" class="text-center mb-6"></p>
        <div class="flex justify-center">
            <button id="alert-modal-ok-btn" class="px-8 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">ตกลง</button>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirmModal" class="modal w-11/12 md:w-1/3 bg-white rounded-xl shadow-2xl p-8">
        <h3 id="confirm-modal-title" class="text-xl font-bold mb-4 text-center">ยืนยันการกระทำ</h3>
        <p id="confirm-modal-text" class="text-center mb-6"></p>
        <div class="flex justify-center gap-4">
            <button id="confirm-modal-cancel-btn" class="px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">ยกเลิก</button>
            <button id="confirm-modal-confirm-btn" class="px-6 py-2 text-white font-bold rounded-lg">ยืนยัน</button>
        </div>
    </div>

    <!-- Modal Backdrop -->
    <div id="modal-backdrop" class="modal-backdrop" onclick="closeAllModals()"></div>

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/th.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, setDoc, getDoc, updateDoc, deleteDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyC1e0VTI5lcUz1y-PiBkjvIfXqRULM766Q",
            authDomain: "cnx-home-7e61b.firebaseapp.com",
            projectId: "cnx-home-7e61b",
            storageBucket: "cnx-home-7e61b.appspot.com",
            messagingSenderId: "788017278292",
            appId: "1:788017278292:web:6aef703d5dfb5f735facc1"
        };
        
        // --- ADMIN CONFIGURATION ---
        const ADMIN_UIDS = ["sjS5xozHNnOkVlQ55DiMCi4b7ft1"]; // Replace with actual Admin User IDs from Firebase Auth
        
        // --- CLOUDINARY CONFIGURATION ---
        const CLOUDINARY_CLOUD_NAME = "dgqb5fbdh";
        const CLOUDINARY_UPLOAD_PRESET = "chaoyouhome_preset";

        // --- INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const listingsCollection = collection(db, "listings");
        const usersCollection = collection(db, "users");

        let currentUser = null;
        let thailandData = {};
        let confirmCallback = null;

        // --- UI ELEMENTS ---
        const homeView = document.getElementById('home-view');
        const listingDetailView = document.getElementById('listing-detail-view');
        const profileView = document.getElementById('profile-view');
        const navLoggedOutView = document.getElementById('nav-logged-out-view');
        const navLoggedInView = document.getElementById('nav-logged-in-view');
        const profileDropdownButton = document.getElementById('profile-dropdown-button');
        const dropdownUserInitial = document.getElementById('dropdown-user-initial');
        const dropdownUsername = document.getElementById('dropdown-username');
        const dropdownEmail = document.getElementById('dropdown-email');
        const listingsGrid = document.getElementById('listings-grid');
        const generalListingsGrid = document.getElementById('general-listings-grid');
        const boostedListingsContainer = document.getElementById('boosted-listings-container');
        const generalListingsContainer = document.getElementById('general-listings-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const listingsTitle = document.getElementById('listings-title');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileNavLoggedOutView = document.getElementById('mobile-nav-logged-out-view');
        const mobileNavLoggedInView = document.getElementById('mobile-nav-logged-in-view');
        
        // --- MODAL & FORM ELEMENTS ---
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const postForm = document.getElementById('post-form');
        const editProfileForm = document.getElementById('edit-profile-form');
        const imageUploadInput = document.getElementById('post-image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const postSubmitButton = document.getElementById('post-submit-button');

        // --- HELPER FUNCTIONS ---
        function translateFirebaseError(errorCode) {
            switch (errorCode) {
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential':
                    return 'อีเมลหรือรหัสผ่านไม่ถูกต้อง';
                case 'auth/invalid-email':
                    return 'รูปแบบอีเมลไม่ถูกต้อง';
                case 'auth/email-already-in-use':
                    return 'อีเมลนี้ถูกใช้งานแล้ว';
                case 'auth/weak-password':
                    return 'รหัสผ่านต้องมีความยาวอย่างน้อย 6 ตัวอักษร';
                case 'auth/too-many-requests':
                    return 'ตรวจพบกิจกรรมที่น่าสงสัย บัญชีของคุณถูกระงับชั่วคราว';
                default:
                    return 'เกิดข้อผิดพลาดที่ไม่รู้จัก กรุณาลองใหม่อีกครั้ง';
            }
        }

        function formatTimestamp(timestamp) {
            if (!timestamp || !timestamp.seconds) {
                return '';
            }
            const now = new Date();
            const postDate = new Date(timestamp.seconds * 1000);
            const diffInSeconds = Math.floor((now - postDate) / 1000);
            const diffInDays = Math.floor(diffInSeconds / 86400);

            if (diffInDays < 7) {
                if (diffInSeconds < 60) return `${diffInSeconds} วินาทีที่แล้ว`;
                const diffInMinutes = Math.floor(diffInSeconds / 60);
                if (diffInMinutes < 60) return `${diffInMinutes} นาทีที่แล้ว`;
                const diffInHours = Math.floor(diffInMinutes / 60);
                if (diffInHours < 24) return `${diffInHours} ชั่วโมงที่แล้ว`;
                return `${diffInDays} วันที่แล้ว`;
            } else {
                return postDate.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                });
            }
        }

        // --- LOCATION DATA HANDLING ---
        async function fetchThailandData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/kongvut/thai-province-data/master/api_province_with_amphure_tambon.json');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                thailandData = data.reduce((acc, province) => {
                    acc[province.name_th] = province.amphure.reduce((amphureAcc, amphure) => {
                        amphureAcc[amphure.name_th] = amphure.tambon.map(tambon => tambon.name_th);
                        return amphureAcc;
                    }, {});
                    return acc;
                }, {});

                populateProvinceDropdowns();
            } catch (error) {
                console.error("Failed to fetch Thailand location data:", error);
                thailandData = { "กรุงเทพมหานคร": { "เขตพระนคร": ["พระบรมมหาราชวัง"] } };
                populateProvinceDropdowns();
            }
        }

        function populateProvinceDropdowns() {
            const provinces = Object.keys(thailandData).sort();
            const provinceFilter = document.getElementById('province-filter');
            const postProvince = document.getElementById('post-province');
            
            provinceFilter.innerHTML = '<option value="">ทุกจังหวัด</option>';
            postProvince.innerHTML = '<option value="">-- เลือกจังหวัด --</option>';

            provinces.forEach(prov => {
                provinceFilter.innerHTML += `<option value="${prov}">${prov}</option>`;
                postProvince.innerHTML += `<option value="${prov}">${prov}</option>`;
            });

            postProvince.addEventListener('change', () => populateDistrictDropdowns(postProvince.value));
        }
        
        function populateDistrictDropdowns(province) {
            const postDistrict = document.getElementById('post-district');
            postDistrict.innerHTML = '<option value="">-- เลือกอำเภอ/เขต --</option>';
            document.getElementById('post-subdistrict').innerHTML = '<option value="">-- เลือกตำบล/แขวง --</option>';

            if (province && thailandData[province]) {
                const districts = Object.keys(thailandData[province]).sort();
                districts.forEach(dist => {
                    postDistrict.innerHTML += `<option value="${dist}">${dist}</option>`;
                });
            }
             postDistrict.addEventListener('change', () => populateSubdistrictDropdowns(province, postDistrict.value));
        }

        function populateSubdistrictDropdowns(province, district) {
            const postSubdistrict = document.getElementById('post-subdistrict');
            postSubdistrict.innerHTML = '<option value="">-- เลือกตำบล/แขวง --</option>';
             if (province && district && thailandData[province] && thailandData[province][district]) {
                const subdistricts = thailandData[province][district].sort();
                subdistricts.forEach(sub => {
                    postSubdistrict.innerHTML += `<option value="${sub}">${sub}</option>`;
                });
            }
        }
        
        // --- UI UPDATE FUNCTIONS ---
        function updateNavUI(user) {
            if (user) {
                // --- Update Desktop Nav ---
                navLoggedInView.classList.remove('hidden');
                navLoggedInView.classList.add('flex');
                navLoggedOutView.classList.add('hidden');
                const userInitial = user.username.charAt(0).toUpperCase();
                profileDropdownButton.textContent = userInitial;
                dropdownUserInitial.textContent = userInitial;
                dropdownUsername.textContent = user.username;
                dropdownEmail.textContent = user.email;

                document.getElementById('dropdown-profile-link').onclick = (e) => { e.preventDefault(); navigateToProfile(user.uid); toggleProfileDropdown(); };
                document.getElementById('dropdown-post-link').onclick = (e) => { e.preventDefault(); openModal('postModal'); toggleProfileDropdown(); };
                document.getElementById('dropdown-logout-link').onclick = (e) => { e.preventDefault(); handleLogout(); };
                document.getElementById('header-boost-button').onclick = () => navigateToProfile(user.uid);

                const adminLink = document.getElementById('dropdown-admin-link');
                if (ADMIN_UIDS.includes(user.uid)) {
                    adminLink.classList.remove('hidden');
                    adminLink.classList.add('flex');
                    adminLink.onclick = (e) => { e.preventDefault(); openAdminPanel(); toggleProfileDropdown(); };
                } else {
                    adminLink.classList.add('hidden');
                }

                // --- Update Mobile Nav ---
                mobileNavLoggedInView.classList.remove('hidden');
                mobileNavLoggedOutView.classList.add('hidden');
                
                let mobileAdminLink = '';
                if (ADMIN_UIDS.includes(user.uid)) {
                    mobileAdminLink = `<a href="#" onclick="openAdminPanel(); toggleMobileMenu();" class="block text-left px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100"><i class="fas fa-user-shield mr-2 w-5 text-center"></i>Admin Panel</a>`;
                }

                mobileNavLoggedInView.innerHTML = `
                    <div class="p-4 border-b">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white text-2xl font-bold">${userInitial}</div>
                            <div>
                                <p class="font-semibold">${user.username}</p>
                                <p class="text-sm text-gray-500">${user.email}</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-2 space-y-1">
                        <a href="#" onclick="navigateToProfile('${user.uid}'); toggleMobileMenu();" class="block text-left px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100"><i class="fas fa-user-circle mr-2 w-5 text-center"></i>โปรไฟล์</a>
                        <a href="#" onclick="openModal('postModal'); toggleMobileMenu();" class="block text-left px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100"><i class="fas fa-plus mr-2 w-5 text-center"></i>ลงประกาศ</a>
                        <a href="#" onclick="navigateToProfile('${user.uid}'); toggleMobileMenu();" class="block text-left px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100"><i class="fas fa-rocket mr-2 w-5 text-center"></i>ดันโพสต์</a>
                        ${mobileAdminLink}
                        <hr class="my-1">
                        <a href="#" onclick="handleLogout(); toggleMobileMenu();" class="block text-left px-4 py-3 text-red-500 rounded-lg hover:bg-red-50"><i class="fas fa-sign-out-alt mr-2 w-5 text-center"></i>ออกจากระบบ</a>
                    </div>
                `;

            } else {
                // --- Update Desktop Nav ---
                navLoggedInView.classList.add('hidden');
                navLoggedOutView.classList.remove('hidden');

                // --- Update Mobile Nav ---
                mobileNavLoggedInView.classList.add('hidden');
                mobileNavLoggedOutView.classList.remove('hidden');
            }
        }

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                currentUser = userDocSnap.exists() 
                    ? { uid: user.uid, ...userDocSnap.data() }
                    : { uid: user.uid, email: user.email, username: user.email.split('@')[0] };
            } else {
                currentUser = null;
            }
            updateNavUI(currentUser);
            router();
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value.trim();
            const usernameLower = username.toLowerCase();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const errorEl = document.getElementById('register-error');
            errorEl.textContent = '';

            if (!username) {
                errorEl.textContent = 'กรุณาใส่ Username';
                return;
            }
            if (password !== confirmPassword) {
                errorEl.textContent = 'รหัสผ่านไม่ตรงกัน';
                return;
            }

            const usernameQuery = query(usersCollection, where("username_lowercase", "==", usernameLower));
            const usernameSnapshot = await getDocs(usernameQuery);
            if (!usernameSnapshot.empty) {
                errorEl.textContent = 'Username นี้ถูกใช้งานแล้ว';
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await setDoc(doc(db, "users", user.uid), {
                    username: username,
                    username_lowercase: usernameLower,
                    email: user.email,
                    createdAt: serverTimestamp(),
                    phone: '',
                    lineId: ''
                });

                closeModal('registerModal');
                registerForm.reset();
            } catch (error) {
                console.error("Register error:", error);
                errorEl.textContent = translateFirebaseError(error.code);
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const identifier = document.getElementById('login-identifier').value.trim();
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';
            let emailToLogin;

            try {
                if (identifier.includes('@')) {
                    emailToLogin = identifier;
                } else {
                    const usernameQuery = query(usersCollection, where("username_lowercase", "==", identifier.toLowerCase()));
                    const usernameSnapshot = await getDocs(usernameQuery);

                    if (usernameSnapshot.empty) {
                        errorEl.textContent = 'อีเมลหรือรหัสผ่านไม่ถูกต้อง';
                        return;
                    }
                    const userData = usernameSnapshot.docs[0].data();
                    emailToLogin = userData.email;
                }

                await signInWithEmailAndPassword(auth, emailToLogin, password);
                closeModal('loginModal');
                loginForm.reset();

            } catch (error) {
                console.error("Login error:", error);
                errorEl.textContent = translateFirebaseError(error.code);
            }
        });

        const handleLogout = async () => {
             try {
                await signOut(auth);
                navigateToHome();
            } catch (error) {
                console.error("Logout error:", error);
            }
        };

        // --- IMAGE UPLOAD ---
        async function uploadImages(files) {
            const uploadPromises = Array.from(files).map(file => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                return fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.secure_url) {
                        return data.secure_url;
                    } else {
                        console.error('Cloudinary Error:', data);
                        throw new Error('Cloudinary upload failed');
                    }
                });
            });
            return Promise.all(uploadPromises);
        }

        imageUploadInput.addEventListener('change', () => {
            imagePreviewContainer.innerHTML = '';
            const files = imageUploadInput.files;
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'upload-preview-img';
                    imagePreviewContainer.appendChild(img);
                }
                reader.readAsDataURL(file);
            }
        });

        // --- FIRESTORE (LISTINGS) ---
        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                showAlertModal("กรุณาเข้าสู่ระบบก่อนลงประกาศ");
                return;
            }

            postSubmitButton.disabled = true;
            postSubmitButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>กำลังบันทึก...`;

            try {
                const files = imageUploadInput.files;
                let imageUrls = [];

                if (files.length > 0) {
                    imageUrls = await uploadImages(files);
                }

                const postId = document.getElementById('post-id').value;
                
                if (postId && files.length === 0) {
                    const docRef = doc(db, "listings", postId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        imageUrls = docSnap.data().imageUrls || [];
                    }
                }

                const listingData = {
                    title: document.getElementById('post-title').value,
                    type: document.getElementById('post-type').value,
                    listingType: 'เช่า',
                    priceSale: 0,
                    priceRent: Number(document.getElementById('post-price-rent').value) || 0,
                    priceInitial: Number(document.getElementById('post-price-initial').value) || 0,
                    availableDate: document.getElementById('post-available-date').value || '',
                    province: document.getElementById('post-province').value,
                    district: document.getElementById('post-district').value,
                    subdistrict: document.getElementById('post-subdistrict').value,
                    description: document.getElementById('post-description').value,
                    imageUrls: imageUrls,
                    phone: document.getElementById('post-phone').value,
                    lineId: document.getElementById('post-line-id').value,
                    ownerUid: currentUser.uid,
                    ownerEmail: currentUser.email,
                    ownerUsername: currentUser.username,
                    updatedAt: serverTimestamp(),
                };

                if (postId) {
                    const docRef = doc(db, "listings", postId);
                    await updateDoc(docRef, listingData);
                } else {
                    listingData.createdAt = serverTimestamp();
                    listingData.isBoosted = false;
                    await addDoc(listingsCollection, listingData);
                }
                closeModal('postModal');
                postForm.reset();
                imagePreviewContainer.innerHTML = '';
                fetchListings();
                showAlertModal('บันทึกประกาศสำเร็จ!');
            } catch (error) {
                console.error("Error saving listing:", error);
                document.getElementById('post-error').textContent = "เกิดข้อผิดพลาดในการบันทึก: " + error.message;
            } finally {
                postSubmitButton.disabled = false;
                postSubmitButton.innerHTML = `บันทึกประกาศ`;
            }
        });

        async function fetchListings(filters = {}) {
            loadingSpinner.style.display = 'block';
            listingsGrid.innerHTML = '';
            generalListingsGrid.innerHTML = '';
            
            try {
                const querySnapshot = await getDocs(query(listingsCollection));
                let allListings = [];
                querySnapshot.forEach((doc) => {
                    allListings.push({ id: doc.id, ...doc.data() });
                });

                let filteredListings = allListings;

                if (filters.myListings) {
                    filteredListings = filteredListings.filter(l => l.ownerUid === currentUser.uid);
                }
                if (filters.province) {
                    filteredListings = filteredListings.filter(l => l.province === filters.province);
                }
                if (filters.district) {
                    filteredListings = filteredListings.filter(l => l.district === filters.district);
                }
                if (filters.type) {
                    filteredListings = filteredListings.filter(l => l.type === filters.type);
                }
                if (filters.maxPrice && filters.maxPrice > 0) {
                    filteredListings = filteredListings.filter(listing => {
                        const rentPrice = listing.priceRent || 0;
                        return rentPrice > 0 && rentPrice <= filters.maxPrice;
                    });
                }

                filteredListings.sort((a, b) => {
                    if (a.isBoosted && !b.isBoosted) return -1;
                    if (!a.isBoosted && b.isBoosted) return 1;
                    return (b.updatedAt?.toMillis() || 0) - (a.updatedAt?.toMillis() || 0);
                });

                renderListings(filteredListings, Object.keys(filters).length > 0 && !filters.myListings);
            } catch (error) {
                console.error("Error fetching listings: ", error);
                listingsGrid.innerHTML = `<p class="col-span-full text-center text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}</p>`;
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        function renderListings(listings, isSearchView = false) {
            const boostedListings = listings.filter(l => l.isBoosted);
            const generalListings = listings.filter(l => !l.isBoosted);

            listingsGrid.innerHTML = '';
            generalListingsGrid.innerHTML = '';

            if (isSearchView) {
                populateGrid(listingsGrid, listings, "ไม่พบประกาศที่ตรงกับเงื่อนไขการค้นหา");
            } else {
                populateGrid(listingsGrid, boostedListings, "ยังไม่มีประกาศแนะนำในขณะนี้");
                populateGrid(generalListingsGrid, generalListings, "ไม่พบประกาศทั่วไป");
            }
        }

        function populateGrid(gridElement, listings, emptyMessage) {
            if (listings.length === 0) {
                gridElement.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">${emptyMessage}</p>`;
                return;
            }
            listings.forEach(listing => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-1 transition-transform duration-300 cursor-pointer relative flex flex-col';
                
                const priceDisplay = getPriceDisplay(listing.priceSale, listing.priceRent, listing.listingType);
                const imageUrl = listing.imageUrls && listing.imageUrls.length > 0 ? listing.imageUrls[0] : 'https://placehold.co/600x400/e2e8f0/64748b?text=ไม่มีรูปภาพ';
                const dateDisplay = formatTimestamp(listing.updatedAt);
                const updatedText = (listing.createdAt && listing.updatedAt.seconds > listing.createdAt.seconds + 10) ? ` <span class="text-amber-500">(updated)</span>` : '';


                card.innerHTML = `
                    ${listing.isBoosted ? '<div class="boosted-badge"><i class="fas fa-rocket"></i> ประกาศแนะนำ</div>' : ''}
                    <img src="${imageUrl}" alt="${listing.title}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e2e8f0/64748b?text=รูปภาพเสียหาย';">
                    <div class="p-4 flex flex-col flex-grow">
                        <h4 class="font-bold text-lg break-words">${listing.title}</h4>
                        <p class="text-sm text-gray-500 mb-2"><i class="fas fa-map-marker-alt mr-1"></i> ${listing.district}, ${listing.province}</p>
                        <p class="text-blue-600 font-bold text-xl mb-3">${priceDisplay}</p>
                        <div class="mt-auto flex justify-between items-center text-xs text-gray-500 pt-2 border-t">
                            <span>${listing.type}</span>
                            <span class="font-semibold">${dateDisplay}${updatedText}</span>
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => navigateToListing(listing.id));
                gridElement.appendChild(card);
            });
        }
        
        function getPriceDisplay(sale, rent, type) {
            if (rent > 0) {
                return `฿${rent.toLocaleString()}/เดือน`;
            }
            return 'ติดต่อผู้ให้เช่า';
        }

        async function renderListingPage(listingId) {
            listingDetailView.innerHTML = `<div class="text-center p-10"><i class="fas fa-spinner fa-spin text-3xl"></i></div>`;
            try {
                const docRef = doc(db, "listings", listingId);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    listingDetailView.innerHTML = `<p class="text-center text-red-500">ไม่พบประกาศนี้</p>`;
                    return;
                }
                const listing = { id: docSnap.id, ...docSnap.data() };

                const priceDisplay = getPriceDisplay(listing.priceSale, listing.priceRent, listing.listingType);
                const imageUrls = listing.imageUrls && listing.imageUrls.length > 0 ? listing.imageUrls : ['https://placehold.co/800x600/e2e8f0/64748b?text=ไม่มีรูปภาพ'];
                const dateDisplay = formatTimestamp(listing.updatedAt);
                const updatedText = (listing.createdAt && listing.updatedAt.seconds > listing.createdAt.seconds + 10) ? ' (updated)' : '';
                const initialPriceDisplay = listing.priceInitial > 0 ? `
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <p class="text-md text-gray-800">
                            <i class="fas fa-file-invoice-dollar mr-2 text-green-500"></i>
                            <strong>ราคาเข้าอยู่ครั้งแรก:</strong> ${listing.priceInitial.toLocaleString()} บาท
                        </p>
                    </div>` : '';
                const availableDateDisplay = listing.availableDate ? `
                    <div class="mt-2 p-3 bg-gray-50 rounded-lg">
                        <p class="text-md text-gray-800">
                            <i class="fas fa-calendar-check mr-2 text-blue-500"></i>
                            <strong>วันที่เข้าอยู่ได้:</strong> ${new Date(listing.availableDate).toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric', calendar: 'buddhist' })}
                        </p>
                    </div>` : '';
                
                listingDetailView.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <img id="main-detail-image" src="${imageUrls[0]}" class="w-full h-96 object-cover rounded-lg shadow-md mb-4" onerror="this.onerror=null;this.src='https://placehold.co/800x600/e2e8f0/64748b?text=รูปภาพเสียหาย';">
                            <div class="grid grid-cols-4 gap-2">
                                ${imageUrls.map(url => `<img src="${url}" class="h-24 w-full object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-blue-500" onclick="document.getElementById('main-detail-image').src='${url}'" onerror="this.style.display='none'">`).join('')}
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center">
                                <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">${listing.type}</span>
                                <span class="text-sm text-gray-500"><i class="fas fa-clock mr-1"></i>${dateDisplay}${updatedText}</span>
                            </div>
                            <h3 class="text-3xl font-bold mt-2 mb-2 break-words">${listing.title}</h3>
                            <p class="text-lg text-gray-600 mb-4"><i class="fas fa-map-marker-alt mr-2"></i>${listing.subdistrict}, ${listing.district}, ${listing.province}</p>
                            <p class="text-3xl font-bold text-blue-600 mb-4">${priceDisplay}</p>
                            ${initialPriceDisplay}
                            ${availableDateDisplay}
                            <h5 class="font-bold text-lg mt-6 mb-2">รายละเอียด</h5>
                            <p class="text-gray-700 whitespace-pre-wrap break-words mb-6">${listing.description}</p>
                            <div class="bg-gray-100 p-4 rounded-lg">
                                 <h5 class="font-bold text-lg mb-2">ข้อมูลติดต่อ</h5>
                                 <p class="text-gray-800"><i class="fas fa-user mr-2"></i><a href="#" onclick="event.preventDefault(); navigateToProfile('${listing.ownerUid}')" class="text-blue-600 hover:underline">${listing.ownerUsername || listing.ownerEmail}</a></p>
                                 <p class="text-gray-800"><i class="fas fa-phone mr-2"></i><a href="tel:${listing.phone}" class="text-blue-600 hover:underline">${listing.phone || '-'}</a></p>
                                 <p class="text-gray-800"><i class="fab fa-line mr-2"></i><a href="https://line.me/ti/p/~${listing.lineId}" target="_blank" rel="noopener noreferrer" class="text-green-500 hover:underline">${listing.lineId || '-'}</a></p>
                            </div>
                            ${(currentUser && (currentUser.uid === listing.ownerUid || ADMIN_UIDS.includes(currentUser.uid))) ? `
                                <div class="mt-6 flex gap-4">
                                    <button onclick="editListing('${listing.id}')" class="flex-1 py-3 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600"><i class="fas fa-edit mr-2"></i>แก้ไข</button>
                                    <button onclick="deleteListing('${listing.id}')" class="flex-1 py-3 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600"><i class="fas fa-trash mr-2"></i>ลบ</button>
                                    <button onclick="boostListing('${listing.id}', ${listing.isBoosted})" class="flex-1 py-3 ${listing.isBoosted ? 'bg-gray-400' : 'bg-purple-600'} text-white font-bold rounded-lg hover:bg-purple-700 disabled:opacity-50" ${listing.isBoosted ? 'disabled' : ''}><i class="fas fa-rocket mr-2"></i>${listing.isBoosted ? 'ดันโพสต์แล้ว' : 'ดันโพสต์'}</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error("Error rendering listing page:", error);
                listingDetailView.innerHTML = `<p class="text-center text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูลประกาศ</p>`;
            }
        }

        window.editListing = async function(id) {
            const docRef = doc(db, "listings", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const listing = {id: docSnap.id, ...docSnap.data()};
                
                closeAllModals();
                document.getElementById('post-modal-title').textContent = 'แก้ไขประกาศ';
                document.getElementById('post-id').value = listing.id;
                document.getElementById('post-title').value = listing.title;
                document.getElementById('post-type').value = listing.type;
                document.getElementById('post-price-rent').value = listing.priceRent;
                document.getElementById('post-price-initial').value = listing.priceInitial || '';
                document.getElementById('post-available-date').value = listing.availableDate || '';
                document.getElementById('post-description').value = listing.description;
                
                // For editing, we just show existing URLs. We don't re-upload.
                imagePreviewContainer.innerHTML = '';
                if (listing.imageUrls && listing.imageUrls.length > 0) {
                    listing.imageUrls.forEach(url => {
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = 'upload-preview-img';
                        imagePreviewContainer.appendChild(img);
                    });
                }

                document.getElementById('post-phone').value = listing.phone;
                document.getElementById('post-line-id').value = listing.lineId;
                
                const postProvince = document.getElementById('post-province');
                postProvince.value = listing.province;
                populateDistrictDropdowns(listing.province);
                const postDistrict = document.getElementById('post-district');
                postDistrict.value = listing.district;
                populateSubdistrictDropdowns(listing.province, listing.district);
                document.getElementById('post-subdistrict').value = listing.subdistrict;

                openModal('postModal');
            }
        }

        window.deleteListing = async function(id) {
            openConfirmModal('คุณแน่ใจหรือไม่ว่าต้องการลบประกาศนี้?', async () => {
                try {
                    await deleteDoc(doc(db, "listings", id));
                    navigateToHome();
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    showAlertModal('เกิดข้อผิดพลาดในการลบ');
                }
            }, 'bg-red-500 hover:bg-red-600');
        }
        
        window.boostListing = async function(id, isAlreadyBoosted) {
            if (isAlreadyBoosted) {
                showAlertModal('ประกาศนี้เป็นประกาศแนะนำอยู่แล้ว');
                return;
            }
            openConfirmModal('การดันโพสต์มีค่าใช้จ่าย คุณต้องการดำเนินการต่อหรือไม่? (นี่เป็นเพียงการจำลอง)', async () => {
                try {
                    const docRef = doc(db, "listings", id);
                    await updateDoc(docRef, {
                        isBoosted: true,
                        updatedAt: serverTimestamp()
                    });
                    showAlertModal('ดันโพสต์สำเร็จ!');
                    router(); // Re-render the current view to show changes
                } catch (error) {
                    console.error("Error boosting post: ", error);
                    showAlertModal('เกิดข้อผิดพลาดในการดันโพสต์');
                }
            }, 'bg-purple-600 hover:bg-purple-700');
        }

        // --- FILTER & VIEW CONTROLS ---
        window.applyFilters = function() {
            const filters = {
                province: document.getElementById('province-filter').value,
                district: document.getElementById('district-filter').value,
                type: document.getElementById('type-filter').value,
                maxPrice: Number(document.getElementById('max-price-filter').value) || null,
                myListings: false
            };
            listingsTitle.innerHTML = 'ผลการค้นหา';
            generalListingsContainer.classList.add('hidden');
            boostedListingsContainer.classList.remove('hidden');
            fetchListings(filters);
        }
        
        // --- ADMIN PANEL ---
        window.openAdminPanel = async function() {
            openModal('adminModal');
            const tableBody = document.getElementById('admin-listings-table');
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4"><i class="fas fa-spinner fa-spin text-2xl"></i></td></tr>`;

            try {
                const querySnapshot = await getDocs(query(listingsCollection, orderBy("updatedAt", "desc")));
                let allListings = [];
                querySnapshot.forEach((doc) => {
                    allListings.push({ id: doc.id, ...doc.data() });
                });
                
                tableBody.innerHTML = '';
                if (allListings.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4">ยังไม่มีประกาศในระบบ</td></tr>`;
                    return;
                }

                allListings.forEach(listing => {
                    const tr = document.createElement('tr');
                    const updatedAt = formatTimestamp(listing.updatedAt);
                    const priceDisplay = getPriceDisplay(listing.priceSale, listing.priceRent, listing.listingType);
                    const updatedText = (listing.createdAt && listing.updatedAt.seconds > listing.createdAt.seconds + 10) ? ' (updated)' : '';

                    tr.innerHTML = `
                        <td class="font-medium">${listing.title}</td>
                        <td>${listing.ownerUsername || listing.ownerEmail}</td>
                        <td>${listing.type}</td>
                        <td>${priceDisplay}</td>
                        <td>${updatedAt}${updatedText}</td>
                        <td class="flex gap-2 items-center">
                            <button onclick="editListing('${listing.id}')" title="แก้ไข" class="text-amber-500 hover:text-amber-700"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteListing('${listing.id}')" title="ลบ" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                            <button onclick="boostListing('${listing.id}', ${listing.isBoosted})" title="ดันโพสต์" class="${listing.isBoosted ? 'text-gray-400' : 'text-purple-500 hover:text-purple-700'}" ${listing.isBoosted ? 'disabled' : ''}><i class="fas fa-rocket"></i></button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });

            } catch(error) {
                console.error("Error fetching for admin panel:", error);
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-red-500 p-4">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>`;
            }
        }
        
        // --- USER PROFILE PAGE ---
        async function renderProfilePage(userId) {
            profileView.innerHTML = `<div class="text-center p-10"><i class="fas fa-spinner fa-spin text-3xl"></i></div>`;

            try {
                const userDocRef = doc(db, "users", userId);
                const userDocSnap = await getDoc(userDocRef);

                if (!userDocSnap.exists()) {
                    profileView.innerHTML = `<p class="text-center text-red-500">ไม่พบข้อมูลผู้ใช้</p>`;
                    return;
                }
                const userData = userDocSnap.data();
                const joinedDate = userData.createdAt ? new Date(userData.createdAt.seconds * 1000).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }) : 'ไม่ระบุ';

                const listingsQuery = query(listingsCollection, where("ownerUid", "==", userId));
                const listingsSnapshot = await getDocs(listingsQuery);
                let userListings = [];
                listingsSnapshot.forEach(doc => {
                    userListings.push({ id: doc.id, ...doc.data() });
                });
                
                userListings.sort((a, b) => (b.updatedAt?.toMillis() || 0) - (a.updatedAt?.toMillis() || 0));

                let listingsHtml = '<div class="text-center text-gray-500 mt-6 p-8 border rounded-lg bg-white shadow-md">ผู้ใช้ยังไม่มีประกาศ</div>';
                if (userListings.length > 0) {
                    listingsHtml = userListings.map(listing => {
                        const price = getPriceDisplay(listing.priceSale, listing.priceRent, listing.listingType);
                        const imageUrl = listing.imageUrls && listing.imageUrls.length > 0 ? listing.imageUrls[0] : 'https://placehold.co/600x400/e2e8f0/64748b?text=ไม่มีรูปภาพ';
                        const dateDisplay = formatTimestamp(listing.updatedAt);
                        const updatedText = (listing.createdAt && listing.updatedAt.seconds > listing.createdAt.seconds + 10) ? ` <span class="text-amber-500">(updated)</span>` : '';
                        return `
                            <div class="flex items-center gap-4 p-4 bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow cursor-pointer border" onclick="navigateToListing('${listing.id}')">
                                <img src="${imageUrl}" class="w-28 h-24 object-cover rounded-lg" onerror="this.onerror=null;this.src='https://placehold.co/200x200/e2e8f0/64748b?text=ไม่มีรูป';">
                                <div class="flex-1">
                                    <h5 class="font-bold text-lg">${listing.title}</h5>
                                    <p class="text-sm text-gray-500">${listing.district}, ${listing.province}</p>
                                    <div class="flex justify-between items-center mt-1">
                                        <p class="text-md font-semibold text-blue-600">${price}</p>
                                        <p class="text-xs text-gray-500">${dateDisplay}${updatedText}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                profileView.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md text-center h-fit">
                            <div class="w-32 h-32 bg-blue-500 rounded-full flex items-center justify-center text-white text-5xl font-bold mx-auto">
                                ${userData.username.charAt(0).toUpperCase()}
                            </div>
                            <h3 class="text-3xl font-bold mt-4">${userData.username}</h3>
                            <p class="text-gray-500 mt-1">${userData.email}</p>
                            <p class="text-sm text-gray-400 mt-4"><i class="fas fa-calendar-alt mr-2"></i>เข้าร่วมเมื่อ ${joinedDate}</p>
                            
                            <div class="text-left mt-6 pt-4 border-t">
                                <h4 class="font-semibold mb-2">ข้อมูลติดต่อสาธารณะ</h4>
                                <p class="text-gray-800 text-sm mb-1"><i class="fas fa-phone mr-2 w-4 text-center"></i>${userData.phone || 'ยังไม่ได้ระบุ'}</p>
                                <p class="text-gray-800 text-sm"><i class="fab fa-line mr-2 w-4 text-center"></i>${userData.lineId || 'ยังไม่ได้ระบุ'}</p>
                            </div>

                            ${(currentUser && currentUser.uid === userId) ? `
                                <button onclick="openEditProfileModal()" class="mt-4 w-full py-2 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600">แก้ไขโปรไฟล์</button>
                            ` : ''}
                        </div>
                        <div class="lg:col-span-3">
                             <h4 class="text-2xl font-bold mb-4">ประกาศทั้งหมด (${userListings.length})</h4>
                             <div class="space-y-4">
                                ${listingsHtml}
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                 console.error("Error showing user profile:", error);
                 profileView.innerHTML = `<p class="text-center text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูลโปรไฟล์</p>`;
            }
        }

        // --- ROUTING ---
        function hideAllViews() {
            homeView.classList.add('hidden');
            listingDetailView.classList.add('hidden');
            profileView.classList.add('hidden');
        }

        function router() {
            const hash = window.location.hash;
            hideAllViews();
            mobileMenu.classList.add('hidden'); // Close mobile menu on route change

            if (hash.startsWith('#listing/')) {
                const listingId = hash.substring('#listing/'.length);
                listingDetailView.classList.remove('hidden');
                renderListingPage(listingId);
            } else if (hash.startsWith('#profile/')) {
                const userId = hash.substring('#profile/'.length);
                profileView.classList.remove('hidden');
                renderProfilePage(userId);
            } else {
                homeView.classList.remove('hidden');
                listingsTitle.innerHTML = 'ประกาศแนะนำ <i class="fas fa-star text-yellow-400"></i>';
                generalListingsContainer.classList.remove('hidden');
                boostedListingsContainer.classList.remove('hidden');
                fetchListings(); 
            }
        }
        
        window.navigateToHome = () => window.location.hash = '';
        window.navigateToListing = (id) => window.location.hash = `#listing/${id}`;
        window.navigateToProfile = (id) => window.location.hash = `#profile/${id}`;

        // --- MODAL CONTROLS ---
        const backdrop = document.getElementById('modal-backdrop');
        window.openModal = (modalId) => {
            if (modalId === 'postModal') {
                flatpickr("#post-available-date", {
                    locale: "th",
                    minDate: "today",
                    dateFormat: "Y-m-d",
                });
                if (!document.getElementById('post-id').value) {
                    document.getElementById('post-form').reset();
                    document.getElementById('post-modal-title').textContent = 'ลงประกาศอสังหาริมทรัพย์';
                    populateDistrictDropdowns('');
                }
            }
            document.getElementById(modalId).style.display = 'block';
            backdrop.style.display = 'block';
        };
        window.closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
            backdrop.style.display = 'none';
            const errorEls = document.querySelectorAll('#login-error, #register-error, #post-error');
            errorEls.forEach(el => el.textContent = '');
        };
        window.closeAllModals = () => {
            document.querySelectorAll('.modal').forEach(modal => closeModal(modal.id));
        };

        // --- CUSTOM ALERT & CONFIRM MODALS ---
        window.showAlertModal = (message, title = 'แจ้งเตือน') => {
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-text').textContent = message;
            openModal('alertModal');
        };

        window.openConfirmModal = (message, onConfirm, confirmButtonClass = 'bg-red-500 hover:bg-red-600') => {
            document.getElementById('confirm-modal-text').textContent = message;
            const confirmBtn = document.getElementById('confirm-modal-confirm-btn');
            confirmBtn.className = `px-6 py-2 text-white font-bold rounded-lg ${confirmButtonClass}`;
            confirmCallback = onConfirm;
            openModal('confirmModal');
        };
        
        // --- EVENT LISTENERS ---
        document.getElementById('province-filter').addEventListener('change', (e) => {
            const districtFilter = document.getElementById('district-filter');
            districtFilter.innerHTML = '<option value="">ทุกอำเภอ/เขต</option>';
            const province = e.target.value;
            if (province && thailandData[province]) {
                const districts = Object.keys(thailandData[province]).sort();
                districts.forEach(dist => {
                    districtFilter.innerHTML += `<option value="${dist}">${dist}</option>`;
                });
            }
        });

        document.getElementById('confirm-modal-cancel-btn').addEventListener('click', () => {
            closeModal('confirmModal');
            confirmCallback = null;
        });

        document.getElementById('confirm-modal-confirm-btn').addEventListener('click', () => {
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
            closeModal('confirmModal');
            confirmCallback = null;
        });

        document.getElementById('alert-modal-ok-btn').addEventListener('click', () => {
            closeModal('alertModal');
        });

        // --- SLIDESHOW LOGIC ---
        let currentSlide = 0;
        let slideInterval;
        const slides = document.querySelectorAll('#banner-slideshow .slide');
        const dotsContainer = document.getElementById('slide-dots');

        function showSlide(n) {
            slides.forEach((slide, index) => {
                slide.style.opacity = index === n ? '1' : '0';
            });
            document.querySelectorAll('#slide-dots .dot').forEach((dot, index) => {
                dot.classList.toggle('bg-white', index === n);
                dot.classList.toggle('bg-white/50', index !== n);
            });
            currentSlide = n;
        }

        function nextSlide() {
            showSlide((currentSlide + 1) % slides.length);
        }

        function prevSlide() {
            showSlide((currentSlide - 1 + slides.length) % slides.length);
        }

        function startSlideshow() {
            stopSlideshow();
            slideInterval = setInterval(nextSlide, 5000);
        }

        function stopSlideshow() {
            clearInterval(slideInterval);
        }
        
        // --- PROFILE DROPDOWN & MOBILE MENU ---
        const profileDropdownMenu = document.getElementById('profile-dropdown-menu');
        window.toggleProfileDropdown = () => {
            profileDropdownMenu.classList.toggle('hidden');
        }
        window.toggleMobileMenu = () => {
            mobileMenu.classList.toggle('hidden');
        }

        document.addEventListener('click', (event) => {
            const profileButton = document.getElementById('profile-dropdown-button');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            if (profileButton && !profileButton.contains(event.target) && !profileDropdownMenu.contains(event.target)) {
                profileDropdownMenu.classList.add('hidden');
            }
            if (mobileMenuButton && !mobileMenuButton.contains(event.target) && !mobileMenu.contains(event.target)) {
                mobileMenu.classList.add('hidden');
            }
        });

        // --- EDIT PROFILE ---
        window.openEditProfileModal = () => {
            document.getElementById('edit-profile-phone').value = currentUser.phone || '';
            document.getElementById('edit-profile-line').value = currentUser.lineId || '';
            openModal('editProfileModal');
        };

        editProfileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = document.getElementById('edit-profile-phone').value;
            const lineId = document.getElementById('edit-profile-line').value;
            
            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                await updateDoc(userDocRef, { phone, lineId });
                
                currentUser.phone = phone;
                currentUser.lineId = lineId;

                closeModal('editProfileModal');
                router(); 
            } catch (error) {
                console.error("Error updating profile:", error);
                showAlertModal('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
            }
        });

        // --- INITIAL LOAD & ROUTE HANDLING ---
        window.addEventListener('hashchange', router);
        window.addEventListener('DOMContentLoaded', () => {
             fetchThailandData();
             
             if (slides.length > 0) {
                 slides.forEach((_, i) => {
                     const dot = document.createElement('button');
                     dot.classList.add('dot', 'w-3', 'h-3', 'rounded-full', 'transition-colors');
                     dot.addEventListener('click', () => {
                         showSlide(i);
                         stopSlideshow();
                         startSlideshow();
                     });
                     dotsContainer.appendChild(dot);
                 });
                 document.getElementById('prev-slide').addEventListener('click', () => {
                     prevSlide();
                     stopSlideshow();
                     startSlideshow();
                 });
                 document.getElementById('next-slide').addEventListener('click', () => {
                     nextSlide();
                     stopSlideshow();
                     startSlideshow();
                 });
                 showSlide(0);
                 startSlideshow();
             }
        });
        
    </script>
</body>
</html>
