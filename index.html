<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FindYourHome - ค้นหาบ้านและคอนโดในฝันของคุณ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f8f9fa;
        }
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            z-index: 40;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            max-height: 90vh;
            overflow-y: auto;
        }
        .boosted-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background-color: #ffc107;
            color: #212529;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Main Container -->
    <div id="app" class="container mx-auto p-4 md:p-6">

        <!-- Header -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b">
            <h1 class="text-2xl md:text-3xl font-bold text-blue-600">
                <i class="fas fa-home mr-2"></i>FindYourHome
            </h1>
            <nav id="nav-links" class="flex items-center gap-4">
                <!-- Logged Out State -->
                <div id="logged-out-view">
                    <button onclick="openModal('loginModal')" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-blue-600">เข้าสู่ระบบ</button>
                    <button onclick="openModal('registerModal')" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">สมัครสมาชิก</button>
                </div>
                <!-- Logged In State -->
                <div id="logged-in-view" class="hidden items-center gap-4">
                    <span id="user-email-display" class="text-sm text-gray-600 hidden md:block"></span>
                    <button onclick="openModal('postModal')" class="px-4 py-2 text-sm font-medium text-white bg-green-500 rounded-lg hover:bg-green-600"><i class="fas fa-plus mr-1"></i> ลงประกาศ</button>
                    <button onclick="showMyListings()" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-blue-600">ประกาศของฉัน</button>
                    <button id="logout-button" class="px-4 py-2 text-sm font-medium text-red-500 hover:text-red-700">ออกจากระบบ</button>
                </div>
            </nav>
        </header>

        <!-- Search and Filter Section -->
        <div id="search-section" class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-bold mb-4">ค้นหาอสังหาริมทรัพย์ในฝันของคุณ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <select id="province-filter" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500">
                    <option value="">ทุกจังหวัด</option>
                </select>
                <select id="district-filter" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500">
                    <option value="">ทุกอำเภอ/เขต</option>
                </select>
                <input type="number" id="max-price-filter" placeholder="ราคาสูงสุด (บาท)" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500">
                <button onclick="applyFilters()" class="w-full p-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-search mr-2"></i>ค้นหา
                </button>
            </div>
        </div>
        
        <!-- Main Content: Listings Display -->
        <main id="listings-container">
            <h3 class="text-2xl font-bold mb-6" id="listings-title">ประกาศแนะนำ <i class="fas fa-star text-yellow-400"></i></h3>
            <div id="listings-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Listing cards will be injected here by JavaScript -->
                <div id="loading-spinner" class="col-span-full text-center p-10">
                    <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
                    <p class="mt-2">กำลังโหลดข้อมูล...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Login Modal -->
    <div id="loginModal" class="modal w-11/12 md:w-1/3 bg-white rounded-xl shadow-2xl p-8">
        <h3 class="text-2xl font-bold mb-6 text-center">เข้าสู่ระบบ</h3>
        <form id="login-form">
            <div class="mb-4">
                <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">อีเมล</label>
                <input type="email" id="login-email" class="w-full p-3 border rounded-lg" required>
            </div>
            <div class="mb-6">
                <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน</label>
                <input type="password" id="login-password" class="w-full p-3 border rounded-lg" required>
            </div>
            <button type="submit" class="w-full p-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">เข้าสู่ระบบ</button>
        </form>
        <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
        <button onclick="closeModal('loginModal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal w-11/12 md:w-1/3 bg-white rounded-xl shadow-2xl p-8">
        <h3 class="text-2xl font-bold mb-6 text-center">สมัครสมาชิก</h3>
        <form id="register-form">
            <div class="mb-4">
                <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">อีเมล</label>
                <input type="email" id="register-email" class="w-full p-3 border rounded-lg" required>
            </div>
            <div class="mb-4">
                <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน</label>
                <input type="password" id="register-password" class="w-full p-3 border rounded-lg" required>
            </div>
             <div class="mb-6">
                <label for="register-confirm-password" class="block text-sm font-medium text-gray-700 mb-1">ยืนยันรหัสผ่าน</label>
                <input type="password" id="register-confirm-password" class="w-full p-3 border rounded-lg" required>
            </div>
            <button type="submit" class="w-full p-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">สมัครสมาชิก</button>
        </form>
        <p id="register-error" class="text-red-500 text-sm mt-4 text-center"></p>
        <button onclick="closeModal('registerModal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
    </div>

    <!-- Post/Edit Listing Modal -->
    <div id="postModal" class="modal w-11/12 md:w-2/3 lg:w-1/2 bg-white rounded-xl shadow-2xl p-8">
        <h3 id="post-modal-title" class="text-2xl font-bold mb-6 text-center">ลงประกาศอสังหาริมทรัพย์</h3>
        <form id="post-form">
            <input type="hidden" id="post-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium">หัวข้อประกาศ</label>
                    <input type="text" id="post-title" class="w-full p-2 border rounded-lg" placeholder="เช่น คอนโดให้เช่า ใกล้ BTS อ่อนนุช" required>
                </div>
                <div>
                    <label class="block text-sm font-medium">ประเภท</label>
                    <select id="post-type" class="w-full p-2 border rounded-lg" required>
                        <option value="คอนโด">คอนโด</option>
                        <option value="บ้านเดี่ยว">บ้านเดี่ยว</option>
                        <option value="ทาวน์เฮาส์">ทาวน์เฮาส์</option>
                        <option value="ที่ดิน">ที่ดิน</option>
                        <option value="อาคารพาณิชย์">อาคารพาณิชย์</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium">รายการ</label>
                    <select id="post-listing-type" class="w-full p-2 border rounded-lg" required>
                        <option value="เช่า">ให้เช่า</option>
                        <option value="ขาย">ขาย</option>
                        <option value="ขายและเช่า">ขายและเช่า</option>
                    </select>
                </div>
                <div>
                     <label class="block text-sm font-medium">ราคาขาย (บาท)</label>
                     <input type="number" id="post-price-sale" class="w-full p-2 border rounded-lg" placeholder="ถ้าไม่ขาย ใส่ 0">
                </div>
                 <div>
                     <label class="block text-sm font-medium">ราคาเช่า (บาท/เดือน)</label>
                     <input type="number" id="post-price-rent" class="w-full p-2 border rounded-lg" placeholder="ถ้าไม่ให้เช่า ใส่ 0">
                </div>
                <div>
                    <label class="block text-sm font-medium">จังหวัด</label>
                    <select id="post-province" class="w-full p-2 border rounded-lg" required></select>
                </div>
                <div>
                    <label class="block text-sm font-medium">อำเภอ/เขต</label>
                    <select id="post-district" class="w-full p-2 border rounded-lg" required></select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium">ตำบล/แขวง</label>
                    <select id="post-subdistrict" class="w-full p-2 border rounded-lg" required></select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium">รายละเอียดเพิ่มเติม</label>
                    <textarea id="post-description" rows="4" class="w-full p-2 border rounded-lg" required></textarea>
                </div>
                <div class="md:col-span-2">
                     <label class="block text-sm font-medium">รูปภาพ (URL)</label>
                     <input type="text" id="post-image-url" class="w-full p-2 border rounded-lg" placeholder="ใส่ URL รูปภาพหลัก คั่นด้วยจุลภาค (,) สำหรับหลายรูป" required>
                     <small class="text-gray-500">ในเวอร์ชันทดสอบนี้ ให้ใช้ URL ของรูปภาพแทนการอัปโหลด</small>
                </div>
                 <div class="md:col-span-2">
                    <label class="block text-sm font-medium">ข้อมูลติดต่อ (เบอร์โทร หรือ Line ID)</label>
                    <input type="text" id="post-contact" class="w-full p-2 border rounded-lg" required>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-4">
                 <button type="button" onclick="closeModal('postModal')" class="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                 <button type="submit" class="px-6 py-2 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600">บันทึกประกาศ</button>
            </div>
        </form>
         <p id="post-error" class="text-red-500 text-sm mt-4 text-center"></p>
        <button onclick="closeModal('postModal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
    </div>

    <!-- Listing Detail Modal -->
    <div id="detailModal" class="modal w-11/12 md:w-3/4 lg:w-2/3 bg-white rounded-xl shadow-2xl p-0">
        <div id="detail-content" class="p-8">
            <!-- Details will be injected here -->
        </div>
        <button onclick="closeModal('detailModal')" class="absolute top-4 right-4 text-gray-600 bg-white/70 rounded-full w-8 h-8 flex items-center justify-center hover:bg-white text-2xl z-10">&times;</button>
    </div>

    <!-- Modal Backdrop -->
    <div id="modal-backdrop" class="modal-backdrop" onclick="closeAllModals()"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, deleteDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        // Firebase configuration has been updated with your project details.
        const firebaseConfig = {
            apiKey: "AIzaSyDN8_ZJrW3nmhsIqVQnzbkzXu0KFq8IAj8",
            authDomain: "chiangmai-home.firebaseapp.com",
            projectId: "chiangmai-home",
            storageBucket: "chiangmai-home.appspot.com",
            messagingSenderId: "485166978897",
            appId: "1:485166978897:web:8d6d2e90adce8173012570",
            measurementId: "G-WR9SN16MMW"
        };

        // --- INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const listingsCollection = collection(db, "listings");

        let currentUser = null;
        let thailandData = {};

        // --- UI ELEMENTS ---
        const loggedOutView = document.getElementById('logged-out-view');
        const loggedInView = document.getElementById('logged-in-view');
        const userEmailDisplay = document.getElementById('user-email-display');
        const listingsGrid = document.getElementById('listings-grid');
        const loadingSpinner = document.getElementById('loading-spinner');
        const listingsTitle = document.getElementById('listings-title');
        
        // --- MODAL & FORM ELEMENTS ---
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const postForm = document.getElementById('post-form');
        const logoutButton = document.getElementById('logout-button');

        // --- LOCATION DATA HANDLING ---
        async function fetchThailandData() {
            try {
                // In a real app, this would be a larger, more robust data source.
                const response = await fetch('https://raw.githubusercontent.com/kongvut/thai-province-data/master/api_province_with_amphure_tambon.json');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                // Restructure data for easier access
                thailandData = data.reduce((acc, province) => {
                    acc[province.name_th] = province.amphure.reduce((amphureAcc, amphure) => {
                        amphureAcc[amphure.name_th] = amphure.tambon.map(tambon => tambon.name_th);
                        return amphureAcc;
                    }, {});
                    return acc;
                }, {});

                populateProvinceDropdowns();
            } catch (error) {
                console.error("Failed to fetch Thailand location data:", error);
                // Fallback with some data
                thailandData = { "กรุงเทพมหานคร": { "เขตพระนคร": ["พระบรมมหาราชวัง"] } };
                populateProvinceDropdowns();
            }
        }

        function populateProvinceDropdowns() {
            const provinces = Object.keys(thailandData).sort();
            const provinceFilter = document.getElementById('province-filter');
            const postProvince = document.getElementById('post-province');
            
            provinceFilter.innerHTML = '<option value="">ทุกจังหวัด</option>';
            postProvince.innerHTML = '<option value="">-- เลือกจังหวัด --</option>';

            provinces.forEach(prov => {
                provinceFilter.innerHTML += `<option value="${prov}">${prov}</option>`;
                postProvince.innerHTML += `<option value="${prov}">${prov}</option>`;
            });

            postProvince.addEventListener('change', () => populateDistrictDropdowns(postProvince.value));
        }
        
        function populateDistrictDropdowns(province) {
            const postDistrict = document.getElementById('post-district');
            postDistrict.innerHTML = '<option value="">-- เลือกอำเภอ/เขต --</option>';
            document.getElementById('post-subdistrict').innerHTML = '<option value="">-- เลือกตำบล/แขวง --</option>';

            if (province && thailandData[province]) {
                const districts = Object.keys(thailandData[province]).sort();
                districts.forEach(dist => {
                    postDistrict.innerHTML += `<option value="${dist}">${dist}</option>`;
                });
            }
             postDistrict.addEventListener('change', () => populateSubdistrictDropdowns(province, postDistrict.value));
        }

        function populateSubdistrictDropdowns(province, district) {
            const postSubdistrict = document.getElementById('post-subdistrict');
            postSubdistrict.innerHTML = '<option value="">-- เลือกตำบล/แขวง --</option>';
             if (province && district && thailandData[province] && thailandData[province][district]) {
                const subdistricts = thailandData[province][district].sort();
                subdistricts.forEach(sub => {
                    postSubdistrict.innerHTML += `<option value="${sub}">${sub}</option>`;
                });
            }
        }

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                // User is signed in
                loggedInView.classList.remove('hidden');
                loggedInView.classList.add('flex');
                loggedOutView.classList.add('hidden');
                userEmailDisplay.textContent = user.email;
            } else {
                // User is signed out
                loggedInView.classList.add('hidden');
                loggedInView.classList.remove('flex');
                loggedOutView.classList.remove('hidden');
                userEmailDisplay.textContent = '';
            }
            fetchListings(); // Fetch listings on auth state change
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const errorEl = document.getElementById('register-error');
            errorEl.textContent = '';

            if (password !== confirmPassword) {
                errorEl.textContent = 'รหัสผ่านไม่ตรงกัน';
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                closeModal('registerModal');
                registerForm.reset();
            } catch (error) {
                console.error("Register error:", error);
                errorEl.textContent = 'การสมัครสมาชิกล้มเหลว: ' + error.message;
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeModal('loginModal');
                loginForm.reset();
            } catch (error) {
                console.error("Login error:", error);
                errorEl.textContent = 'อีเมลหรือรหัสผ่านไม่ถูกต้อง';
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
            }
        });

        // --- FIRESTORE (LISTINGS) ---
        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                alert("กรุณาเข้าสู่ระบบก่อนลงประกาศ");
                return;
            }

            const postId = document.getElementById('post-id').value;
            const listingData = {
                title: document.getElementById('post-title').value,
                type: document.getElementById('post-type').value,
                listingType: document.getElementById('post-listing-type').value,
                priceSale: Number(document.getElementById('post-price-sale').value) || 0,
                priceRent: Number(document.getElementById('post-price-rent').value) || 0,
                province: document.getElementById('post-province').value,
                district: document.getElementById('post-district').value,
                subdistrict: document.getElementById('post-subdistrict').value,
                description: document.getElementById('post-description').value,
                imageUrls: document.getElementById('post-image-url').value.split(',').map(url => url.trim()),
                contact: document.getElementById('post-contact').value,
                ownerUid: currentUser.uid,
                ownerEmail: currentUser.email,
                isBoosted: false,
                updatedAt: serverTimestamp(),
            };

            try {
                if (postId) {
                    // Update existing document
                    const docRef = doc(db, "listings", postId);
                    await updateDoc(docRef, listingData);
                } else {
                    // Create new document
                    listingData.createdAt = serverTimestamp();
                    await addDoc(listingsCollection, listingData);
                }
                closeModal('postModal');
                postForm.reset();
                fetchListings(); // Refresh list
            } catch (error) {
                console.error("Error saving listing:", error);
                document.getElementById('post-error').textContent = "เกิดข้อผิดพลาดในการบันทึก: " + error.message;
            }
        });

        async function fetchListings(filters = {}) {
            loadingSpinner.style.display = 'block';
            listingsGrid.innerHTML = '';
            
            try {
                let q = query(listingsCollection);

                // Apply filters
                if (filters.province) {
                    q = query(q, where("province", "==", filters.province));
                }
                if (filters.district) {
                    q = query(q, where("district", "==", filters.district));
                }
                if (filters.maxPrice) {
                    // This requires filtering on both sale and rent, which is complex.
                    // For this demo, we'll simplify and filter by rent price if it exists.
                    q = query(q, where("priceRent", "<=", filters.maxPrice));
                }
                if(filters.myListings) {
                    q = query(q, where("ownerUid", "==", currentUser.uid));
                }

                // Default sorting: boosted first, then by date
                q = query(q, orderBy("isBoosted", "desc"), orderBy("updatedAt", "desc"));
                
                const querySnapshot = await getDocs(q);
                const listings = [];
                querySnapshot.forEach((doc) => {
                    listings.push({ id: doc.id, ...doc.data() });
                });

                renderListings(listings);
            } catch (error) {
                console.error("Error fetching listings: ", error);
                listingsGrid.innerHTML = `<p class="col-span-full text-center text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>`;
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        function renderListings(listings) {
            listingsGrid.innerHTML = '';
            if (listings.length === 0) {
                listingsGrid.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">ไม่พบประกาศที่ตรงกับเงื่อนไข</p>`;
                return;
            }
            listings.forEach(listing => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-1 transition-transform duration-300 cursor-pointer relative';
                
                const priceDisplay = getPriceDisplay(listing.priceSale, listing.priceRent, listing.listingType);
                const imageUrl = listing.imageUrls && listing.imageUrls.length > 0 ? listing.imageUrls[0] : 'https://placehold.co/600x400/e2e8f0/64748b?text=ไม่มีรูปภาพ';

                card.innerHTML = `
                    ${listing.isBoosted ? '<div class="boosted-badge"><i class="fas fa-rocket"></i> ประกาศแนะนำ</div>' : ''}
                    <img src="${imageUrl}" alt="${listing.title}" class="w-full h-48 object-cover" onerror="this.src='https://placehold.co/600x400/e2e8f0/64748b?text=รูปภาพเสียหาย'">
                    <div class="p-4">
                        <h4 class="font-bold text-lg truncate">${listing.title}</h4>
                        <p class="text-sm text-gray-500 mb-2"><i class="fas fa-map-marker-alt mr-1"></i> ${listing.district}, ${listing.province}</p>
                        <p class="text-blue-600 font-bold text-xl mb-3">${priceDisplay}</p>
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <span>${listing.type}</span>
                            <span>${listing.listingType}</span>
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => showListingDetail(listing));
                listingsGrid.appendChild(card);
            });
        }
        
        function getPriceDisplay(sale, rent, type) {
            if (type === 'ขาย' && sale > 0) return `฿${sale.toLocaleString()}`;
            if (type === 'เช่า' && rent > 0) return `฿${rent.toLocaleString()}/เดือน`;
            if (type === 'ขายและเช่า') {
                if (sale > 0 && rent > 0) return `฿${rent.toLocaleString()}/ด. | ฿${sale.toLocaleString()}`;
                return sale > 0 ? `฿${sale.toLocaleString()}` : `฿${rent.toLocaleString()}/เดือน`;
            }
            return 'ติดต่อผู้ขาย';
        }

        async function showListingDetail(listing) {
            const detailContent = document.getElementById('detail-content');
            const priceDisplay = getPriceDisplay(listing.priceSale, listing.priceRent, listing.listingType);
            const imageUrls = listing.imageUrls && listing.imageUrls.length > 0 ? listing.imageUrls : ['https://placehold.co/800x600/e2e8f0/64748b?text=ไม่มีรูปภาพ'];
            
            detailContent.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <img id="main-detail-image" src="${imageUrls[0]}" class="w-full h-96 object-cover rounded-lg shadow-md mb-4" onerror="this.src='https://placehold.co/800x600/e2e8f0/64748b?text=รูปภาพเสียหาย'">
                        <div class="grid grid-cols-4 gap-2">
                            ${imageUrls.map(url => `<img src="${url}" class="h-24 w-full object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-blue-500" onclick="document.getElementById('main-detail-image').src='${url}'">`).join('')}
                        </div>
                    </div>
                    <div>
                        <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">${listing.type}</span>
                        <h3 class="text-3xl font-bold mt-2 mb-2">${listing.title}</h3>
                        <p class="text-lg text-gray-600 mb-4"><i class="fas fa-map-marker-alt mr-2"></i>${listing.subdistrict}, ${listing.district}, ${listing.province}</p>
                        <p class="text-3xl font-bold text-blue-600 mb-6">${priceDisplay}</p>
                        <h5 class="font-bold text-lg mb-2">รายละเอียด</h5>
                        <p class="text-gray-700 whitespace-pre-wrap mb-6">${listing.description}</p>
                        <div class="bg-gray-100 p-4 rounded-lg">
                             <h5 class="font-bold text-lg mb-2">ข้อมูลติดต่อ</h5>
                             <p class="text-gray-800"><i class="fas fa-user mr-2"></i>${listing.ownerEmail}</p>
                             <p class="text-gray-800"><i class="fas fa-phone mr-2"></i>${listing.contact}</p>
                        </div>
                        ${currentUser && currentUser.uid === listing.ownerUid ? `
                            <div class="mt-6 flex gap-4">
                                <button onclick="editListing('${listing.id}')" class="flex-1 py-3 bg-yellow-500 text-white font-bold rounded-lg hover:bg-yellow-600">แก้ไข</button>
                                <button onclick="deleteListing('${listing.id}')" class="flex-1 py-3 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600">ลบ</button>
                                <button onclick="boostListing('${listing.id}', ${listing.isBoosted})" class="flex-1 py-3 ${listing.isBoosted ? 'bg-gray-400' : 'bg-purple-600'} text-white font-bold rounded-lg hover:bg-purple-700">${listing.isBoosted ? 'ดันโพสต์แล้ว' : 'ดันโพสต์ (จ่ายเงิน)'}</button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            openModal('detailModal');
        }

        window.editListing = async function(id) {
            const docRef = doc(db, "listings", id);
            const docSnap = await getDocs(query(listingsCollection, where("__name__", "==", id)));
            if (!docSnap.empty) {
                const listing = {id: docSnap.docs[0].id, ...docSnap.docs[0].data()};
                
                closeModal('detailModal');
                document.getElementById('post-modal-title').textContent = 'แก้ไขประกาศ';
                document.getElementById('post-id').value = listing.id;
                document.getElementById('post-title').value = listing.title;
                document.getElementById('post-type').value = listing.type;
                document.getElementById('post-listing-type').value = listing.listingType;
                document.getElementById('post-price-sale').value = listing.priceSale;
                document.getElementById('post-price-rent').value = listing.priceRent;
                document.getElementById('post-description').value = listing.description;
                document.getElementById('post-image-url').value = listing.imageUrls.join(', ');
                document.getElementById('post-contact').value = listing.contact;
                
                // Set location dropdowns
                const postProvince = document.getElementById('post-province');
                postProvince.value = listing.province;
                populateDistrictDropdowns(listing.province);
                const postDistrict = document.getElementById('post-district');
                postDistrict.value = listing.district;
                populateSubdistrictDropdowns(listing.province, listing.district);
                document.getElementById('post-subdistrict').value = listing.subdistrict;

                openModal('postModal');
            }
        }

        window.deleteListing = async function(id) {
            if (confirm('คุณแน่ใจหรือไม่ว่าต้องการลบประกาศนี้?')) {
                try {
                    await deleteDoc(doc(db, "listings", id));
                    closeModal('detailModal');
                    fetchListings();
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    alert('เกิดข้อผิดพลาดในการลบ');
                }
            }
        }
        
        window.boostListing = async function(id, isAlreadyBoosted) {
            if (isAlreadyBoosted) {
                alert('ประกาศนี้เป็นประกาศแนะนำอยู่แล้ว');
                return;
            }
            // In a real app, this would redirect to a payment gateway.
            // Here, we simulate a successful payment.
            if (confirm('การดันโพสต์มีค่าใช้จ่าย คุณต้องการดำเนินการต่อหรือไม่? (นี่เป็นเพียงการจำลอง)')) {
                try {
                    const docRef = doc(db, "listings", id);
                    await updateDoc(docRef, {
                        isBoosted: true
                    });
                    alert('ดันโพสต์สำเร็จ!');
                    closeModal('detailModal');
                    fetchListings();
                } catch (error) {
                    console.error("Error boosting post: ", error);
                    alert('เกิดข้อผิดพลาดในการดันโพสต์');
                }
            }
        }

        // --- FILTER & VIEW CONTROLS ---
        window.applyFilters = function() {
            const filters = {
                province: document.getElementById('province-filter').value,
                district: document.getElementById('district-filter').value,
                maxPrice: Number(document.getElementById('max-price-filter').value) || null,
                myListings: false
            };
            listingsTitle.innerHTML = 'ผลการค้นหา';
            fetchListings(filters);
        }
        
        window.showMyListings = function() {
            if (!currentUser) {
                alert('กรุณาเข้าสู่ระบบเพื่อดูประกาศของคุณ');
                return;
            }
            listingsTitle.innerHTML = 'ประกาศของฉัน';
            fetchListings({ myListings: true });
        }

        // --- MODAL CONTROLS ---
        const backdrop = document.getElementById('modal-backdrop');
        window.openModal = (modalId) => {
            // Reset post form when opening for a new post
            if (modalId === 'postModal' && !document.getElementById('post-id').value) {
                document.getElementById('post-form').reset();
                document.getElementById('post-modal-title').textContent = 'ลงประกาศอสังหาริมทรัพย์';
                populateDistrictDropdowns(''); // Reset districts
            }
            document.getElementById(modalId).style.display = 'block';
            backdrop.style.display = 'block';
        };
        window.closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
            backdrop.style.display = 'none';
            // Clear any error messages
            const errorEls = document.querySelectorAll('#login-error, #register-error, #post-error');
            errorEls.forEach(el => el.textContent = '');
        };
        window.closeAllModals = () => {
            document.querySelectorAll('.modal').forEach(modal => closeModal(modal.id));
        };
        
        // --- EVENT LISTENERS FOR LOCATION FILTERS ---
        document.getElementById('province-filter').addEventListener('change', (e) => {
            const districtFilter = document.getElementById('district-filter');
            districtFilter.innerHTML = '<option value="">ทุกอำเภอ/เขต</option>';
            const province = e.target.value;
            if (province && thailandData[province]) {
                const districts = Object.keys(thailandData[province]).sort();
                districts.forEach(dist => {
                    districtFilter.innerHTML += `<option value="${dist}">${dist}</option>`;
                });
            }
        });

        // --- INITIAL LOAD ---
        fetchThailandData();
        
        // Make functions globally accessible from inline event handlers
        window.fetchListings = fetchListings;
        window.renderListings = renderListings;
        window.showListingDetail = showListingDetail;
        window.deleteListing = deleteListing;
        window.applyFilters = applyFilters;
        window.showMyListings = showMyListings;

    </script>
</body>
</html>